"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _scms = _interopRequireDefault(require("./scms"));

var _createIgnorer = _interopRequireDefault(require("./create-ignorer"));

var _isSupportedExtension = _interopRequireDefault(require("./is-supported-extension"));

var _createMatcher = _interopRequireDefault(require("./create-matcher"));

var _processFiles = _interopRequireDefault(require("./process-files"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * 美化程序封装
 * @param currentDirectory 当前目录
 * @param options 配置参数
 */
const prettier = (currentDirectory, options = {}) => {
  const scm = (0, _scms.default)(currentDirectory);
  const staged = options.staged,
        branch = options.branch,
        since = options.since,
        check = options.check,
        config = options.config,
        bail = options.bail,
        verbose = options.verbose,
        _options$restage = options.restage,
        restage = _options$restage === void 0 ? true : _options$restage,
        _onCheckFile = options.onCheckFile,
        _onWriteFile = options.onWriteFile,
        onExamineFile = options.onExamineFile,
        onPartiallyStagedFile = options.onPartiallyStagedFile,
        onFoundSinceRevision = options.onFoundSinceRevision,
        onFoundChangedFiles = options.onFoundChangedFiles,
        pattern = options.pattern;

  if (!scm) {
    throw new Error('Unable to detect a source control manager.');
  }

  const directory = scm.rootDirectory;
  const revision = since || scm.getSinceRevision(directory, {
    staged,
    branch
  });
  onFoundSinceRevision && onFoundSinceRevision(scm.name, revision);
  const rootIgnorer = (0, _createIgnorer.default)(directory);
  const cwdIgnorer = currentDirectory !== directory ? (0, _createIgnorer.default)(currentDirectory) : () => true;
  const changedFiles = scm.getChangedFiles(directory, revision, staged).filter(_isSupportedExtension.default).filter((0, _createMatcher.default)(pattern)).filter(rootIgnorer).filter(cwdIgnorer);
  const unstagedFiles = staged ? scm.getUnstagedChangedFiles(directory).filter(_isSupportedExtension.default).filter((0, _createMatcher.default)(pattern)).filter(rootIgnorer).filter(cwdIgnorer) : [];

  const wasFullyStaged = f => unstagedFiles.indexOf(f) < 0;

  onFoundChangedFiles && onFoundChangedFiles(changedFiles);
  const failReasons = new Set();
  (0, _processFiles.default)(directory, changedFiles, {
    check,
    config,
    onWriteFile: file => {
      _onWriteFile && _onWriteFile(file);

      if (bail) {
        failReasons.add('BAIL_ON_WRITE');
      }

      if (staged && restage) {
        if (wasFullyStaged(file)) {
          scm.stageFile(directory, file);
        } else {
          onPartiallyStagedFile && onPartiallyStagedFile(file);
          failReasons.add('PARTIALLY_STAGED_FILE');
        }
      }
    },
    onCheckFile: (file, isFormatted) => {
      _onCheckFile && _onCheckFile(file, isFormatted);

      if (!isFormatted) {
        failReasons.add('CHECK_FAILED');
      }
    },
    onExamineFile: verbose && onExamineFile
  });
  return {
    success: failReasons.size === 0,
    errors: Array.from(failReasons)
  };
};

var _default = prettier;
exports.default = _default;